# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: arXiv-daily-ai-enhanced

on:
  schedule:
    - cron: "30 1 * * *"   # UTC æ—¶é—´ï¼›å¯æŒ‰éœ€è°ƒæ•´
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv sync

    - name: Crawl arXiv papers
      id: crawl_step
      run: |
        source .venv/bin/activate
        today=$(date -u "+%Y-%m-%d")
        echo "å¼€å§‹çˆ¬å– $today çš„arXivè®ºæ–‡... / Starting to crawl $today arXiv papers..."

        # å¦‚å­˜åœ¨å½“å¤©æ–‡ä»¶å…ˆåˆ é™¤
        if [ -f "data/${today}.jsonl" ]; then
          echo "ğŸ—‘ï¸ å‘ç°ä»Šæ—¥æ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ é™¤é‡æ–°ç”Ÿæˆ..."
          rm "data/${today}.jsonl"
        fi

        cd daily_arxiv
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
        export LANGUAGE="${{ vars.LANGUAGE }}"
        export CATEGORIES="${{ vars.CATEGORIES }}"
        export MODEL_NAME="${{ vars.MODEL_NAME }}"

        # ç”¨ Scrapy çˆ¬å–
        scrapy crawl arxiv -o ../data/${today}.jsonl

        # æ ¡éªŒäº§ç‰©
        if [ ! -f "../data/${today}.jsonl" ]; then
          echo "çˆ¬å–å¤±è´¥ï¼Œæœªç”Ÿæˆæ•°æ®æ–‡ä»¶"
          exit 1
        fi

        echo "crawl_date=$today" >> $GITHUB_OUTPUT
        echo "çˆ¬å–å®Œæˆ / Crawling completed"

    - name: Filter by keywords
      run: |
        source .venv/bin/activate
        export TODAY="${{ steps.crawl_step.outputs.crawl_date }}"
        export INCLUDE_RAW="${{ vars.KEYWORDS_INCLUDE }}"
        export EXCLUDE_RAW="${{ vars.KEYWORDS_EXCLUDE }}"

        echo "ğŸ” Filtering with include keywords: ${INCLUDE_RAW}"
        echo "ğŸš« Excluding with keywords: ${EXCLUDE_RAW}"

        python - << 'PY'
        import os, re, json
        
        today = os.environ.get("TODAY")
        in_file = f"data/{today}.jsonl"
        out_file = in_file
        
        inc = os.environ.get("INCLUDE_RAW", "").strip()
        exc = os.environ.get("EXCLUDE_RAW", "").strip()
        
        inc_pat = re.compile(inc, re.IGNORECASE) if inc else None
        exc_pat = re.compile(exc, re.IGNORECASE) if exc else None
        
        total, kept = 0, 0
        buf = []

        if os.path.exists(in_file):
            with open(in_file, "r", encoding="utf-8") as f:
                for line in f:
                    total += 1
                    try:
                        obj = json.loads(line)
                    except Exception:
                        continue
                    text = " ".join([
                        str(obj.get("title","")),
                        str(obj.get("summary","")),
                        " ".join(obj.get("categories", [])) if isinstance(obj.get("categories"), list) else str(obj.get("categories","")),
                    ])
                    if inc_pat and not inc_pat.search(text):
                        continue
                    if exc_pat and exc_pat.search(text):
                        continue
                    buf.append(line)
                    kept += 1
        
        with open(out_file, "w", encoding="utf-8") as f:
            for line in buf:
                f.write(line)
        
        print(f"[filter] total={total}, kept={kept}")
        PY

    - name: Check for duplicates
      id: dedup_check
      run: |
        source .venv/bin/activate
        echo "æ‰§è¡Œå»é‡æ£€æŸ¥..."

        cd daily_arxiv
        set +e
        python daily_arxiv/check_stats.py
        dedup_exit_code=$?
        set -e

        echo "å»é‡æ£€æŸ¥é€€å‡ºç : $dedup_exit_code"
        echo "dedup_exit_code=$dedup_exit_code" >> $GITHUB_OUTPUT

        case $dedup_exit_code in
          0)
            echo "has_new_content=true" >> $GITHUB_OUTPUT
            ;;
          1)
            echo "has_new_content=false" >> $GITHUB_OUTPUT
            echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT
            ;;
          2)
            echo "has_new_content=false" >> $GITHUB_OUTPUT
            echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
            exit 1
            ;;
          *)
            echo "has_new_content=false" >> $GITHUB_OUTPUT
            echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
            exit 1
            ;;
        esac

    - name: AI Enhancement Processing
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        source .venv/bin/activate
        today=${{ steps.crawl_step.outputs.crawl_date }}
        echo "å¼€å§‹AIå¢å¼ºå¤„ç†..."

        cd ai
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
        export LANGUAGE="${{ vars.LANGUAGE }}"
        export MODEL_NAME="${{ vars.MODEL_NAME }}"

        python enhance.py --data ../data/${today}.jsonl
        if [ $? -ne 0 ]; then
          echo "AIå¤„ç†å¤±è´¥"
          exit 1
        fi
        echo "AIå¢å¼ºå¤„ç†å®Œæˆ"

    - name: Convert to Markdown
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        source .venv/bin/activate
        today=${{ steps.crawl_step.outputs.crawl_date }}
        echo "è½¬æ¢ä¸ºMarkdownæ ¼å¼..."

        export LANGUAGE="${{ vars.LANGUAGE }}"
        cd to_md

        AI_FILE="../data/${today}_AI_enhanced_${LANGUAGE}.jsonl"
        if [ -f "$AI_FILE" ]; then
          python convert.py --data "$AI_FILE"
        else
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°AIå¢å¼ºæ–‡ä»¶ï¼š$AI_FILE"
          exit 1
        fi
        echo "Markdownè½¬æ¢å®Œæˆ"

    - name: Update file list
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        echo "æ›´æ–°æ–‡ä»¶åˆ—è¡¨..."
        ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt
        echo "æ–‡ä»¶åˆ—è¡¨æ›´æ–°å®Œæˆ"

    - name: Generate password hash and inject into config
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        echo "ğŸ” Generating password hash for authentication..."
        PASSWORD="${{ secrets.ACCESS_PASSWORD }}"
        if [ -z "$PASSWORD" ]; then
          PASSWORD_HASH="DISABLED_NO_PASSWORD_SET_IN_SECRETS"
          echo "âš ï¸ æœªè®¾ç½® ACCESS_PASSWORDï¼Œç½‘é¡µä¸å¯ç”¨ç™»å½•"
        else
          PASSWORD_HASH=$(echo -n "$PASSWORD" | openssl dgst -sha256 -hex | awk '{print $2}')
          echo "âœ… Password hash generated"
        fi
        if [ -f "js/auth-config.js" ]; then
          sed -i "s/PLACEHOLDER_PASSWORD_HASH/$PASSWORD_HASH/" js/auth-config.js
        else
          echo "âŒ ERROR: js/auth-config.js not found!"
          exit 1
        fi
        echo "ğŸ” Authentication setup complete"

    - name: Summary
      run: |
        if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ]; then
          echo "âœ… å·¥ä½œæµå®Œæˆï¼šæœ‰æ–°å†…å®¹å¹¶æˆåŠŸå¤„ç†"
        else
          case "${{ steps.dedup_check.outputs.skip_reason }}" in
            "no_new_content") echo "â„¹ï¸ å»é‡åæ— æ–°å†…å®¹" ;;
            "processing_error") echo "âš ï¸ å»é‡å¤„ç†å‡ºé”™" ;;
            "unknown_error") echo "âš ï¸ æœªçŸ¥é”™è¯¯" ;;
            *) echo "â„¹ï¸ è·³è¿‡å¤„ç†ï¼ˆåŸå› æœªçŸ¥ï¼‰" ;;
          esac
        fi

    - name: Commit changes
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        git config --global user.email "${{ vars.EMAIL }}"
        git config --global user.name "${{ vars.NAME }}"
        git add .
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          exit 0
        fi
        git commit -m "update: $(date -u '+%Y-%m-%d') arXiv papers"
        echo "å˜æ›´å·²æäº¤"

    - name: Pull latest changes and push
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        git config pull.rebase true
        git config rebase.autoStash true
        for i in {1..3}; do
          echo "æ¨é€å°è¯• $i"
          if git push origin main; then
            echo "æ¨é€æˆåŠŸ"
            break
          else
            echo "æ¨é€å¤±è´¥ï¼Œæ‹‰å–æœ€æ–°å˜æ›´åé‡è¯•..."
            git pull origin main --no-edit || true
            if [ $i -eq 3 ]; then
              echo "3æ¬¡å°è¯•åæ¨é€å¤±è´¥"
              exit 1
            fi
          fi
        done
